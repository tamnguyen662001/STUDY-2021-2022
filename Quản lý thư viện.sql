CREATE DATABASE QLTV_TEST
GO
USE QLTV_TEST
GO

CREATE TABLE DOCGIA
(
	MA_DOCGIA NUMERIC IDENTITY(1,1), 
	HO NVARCHAR(10), 
	TENLOT NVARCHAR(20), 
	TEN NVARCHAR(20), 
	NGAYSINH DATE,
	PRIMARY KEY(MA_DOCGIA)
)
GO

CREATE TABLE NGUOILON
(
	MA_DOCGIA NUMERIC IDENTITY(1,1) REFERENCES DOCGIA(MA_DOCGIA), 
	SONHA NVARCHAR(50), 
	DUONG NVARCHAR(50), 
	QUAN NVARCHAR(50), 
	DIENTHOAI NVARCHAR(10),  
	HANSUDUNG DATE,
	PRIMARY KEY(MA_DOCGIA)
)
GO

CREATE TABLE TREEM
(
	MA_DOCGIA NUMERIC IDENTITY(1,1) REFERENCES DOCGIA(MA_DOCGIA), 
	MA_DOCGIA_NGUOILON VARCHAR(5),
	PRIMARY KEY(MA_DOCGIA)
)

CREATE TABLE TUASACH
(
	MA_TUASACH NUMERIC IDENTITY(1,1), 
	TUASACH NVARCHAR(50), 
	TACGIA NVARCHAR(50), 
	TOMTAT NVARCHAR(200),
	PRIMARY KEY(MA_TUASACH)
)
GO

CREATE TABLE DAUSACH
(
	ISBN VARCHAR(10), 
	MA_TUASACH NUMERIC IDENTITY(1,1) REFERENCES TUASACH(MA_TUASACH), 
	NGONNGU NVARCHAR(20), 
	BIA NVARCHAR(20), 
	TRANGTHAI NVARCHAR(10),
	PRIMARY KEY(ISBN)
)
GO

CREATE TABLE MUON
(
	ISBN VARCHAR(10), 
	MA_CUONSACH VARCHAR(5), 
	MA_DOCGIA NUMERIC IDENTITY(1,1), 
	NGAYMUON DATE, 
	NGAYHETHAN DATE,
	PRIMARY KEY(ISBN,MA_CUONSACH)
)
GO

CREATE TABLE CUONSACH
(
	ISBN VARCHAR(10) REFERENCES DAUSACH(ISBN), 
	MA_CUONSACH VARCHAR(5), 
	TINHTRANG NVARCHAR(10),
	PRIMARY KEY(ISBN,MA_CUONSACH)
)
GO

CREATE TABLE DANGKY
(
	ISBN VARCHAR(10) REFERENCES DAUSACH(ISBN), 
	MA_DOCGIA NUMERIC IDENTITY(1,1) REFERENCES DOCGIA(MA_DOCGIA), 
	NGAYDK DATE, 
	GHICHU NVARCHAR(50),
	PRIMARY KEY(ISBN,MA_DOCGIA)
)
GO

CREATE TABLE QUATRINHMUON
(
	ISBN VARCHAR(10), 
	MA_CUONSACH VARCHAR(5), 
	NGAYMUON DATE, 
	MA_DOCGIA NUMERIC IDENTITY(1,1) REFERENCES DOCGIA(MA_DOCGIA), 
	NGAYHETHAN DATE, 
	NGAYTRA DATE, 
	TIENMUON MONEY, 
	TIENDATRA MONEY, 
	TIENDATCOC MONEY, 
	GHICHU NVARCHAR(50),
	PRIMARY KEY(ISBN,MA_CUONSACH,NGAYMUON)
)
GO

ALTER TABLE TREEM
ADD CONSTRAINT FK_NGUOILON FOREIGN KEY(MA_DOCGIA) REFERENCES NGUOILON(MA_DOCGIA)
GO

ALTER TABLE CUONSACH
ADD CONSTRAINT FK_MUON FOREIGN KEY(ISBN,MA_CUONSACH) REFERENCES MUON(ISBN,MA_CUONSACH)
GO

ALTER TABLE QUATRINHMUON
ADD CONSTRAINT FK_CUONSACH FOREIGN KEY(ISBN,MA_CUONSACH) REFERENCES CUONSACH(ISBN,MA_CUONSACH)
GO


INSERT INTO DOCGIA
VALUES
(N'NGUYỄN',N'ÁNH',N'NGỌC','03/20/1978'),
(N'TRẦN',N'TUẤN',N'KHANG','07/12/1980'),
(N'ĐỖ',N'THỊ',N'TÚ','12/12/1982'),
(N'LÊ',N'THỊ',N'HOA','06/15/1987'),
(N'BÙI',N'TUẤN',N'KHANG','05/05/1990')
GO

INSERT INTO NGUOILON
VALUES
('100/22',N'ĐẶNG TẤT',N'PHƯỚC LONG','0913546782','06/12/2000'),
('55/22',N'HUỲNH THÚC KHÁNG',N'PHƯỚC TIẾN','0913546782','07/22/2000'),
('67',N'CỦ CHI',N'LỘC THỌ','0913546782','08/24/2000'),
('33',N'LÝ THÁNH TÔN',N'PHÚ NHUẬN','0913546782','01/11/2000'),
('120/38',N'NGUYỄN TRÃI',N'TÂN LẬP','0913546782','09/25/2000')
GO

INSERT INTO TREEM
VALUES
('DGNL1'),
('DGNL2'),
('DGNL3'),
('DGNL4'),
('DGNL5')
GO

INSERT INTO TUASACH
VALUES
(N'GIẾT CON CHIM NHẠI',N'HARPER LEE','NULL'),
(N'ÔNG TRĂM TUỔI TRÈO QUA CỬA SỔ VÀ BIẾN MẤT',N'JONAS JONASSON','NULL'),
(N'5 CENTIMET TRÊN GIÂY',N'SHINKAI MAKOTO','NULL'),
(N'ÔNG GIÀ VÀ BIỂN CẢ',N'ERNEST HEMINGWAY','NULL'),
(N'ĐIỀU KỲ DIỆU CỦA TIỆM TẠP HÓA NAMIYA','HIGASHINO KEIGO',N'NULL')
GO

INSERT INTO DAUSACH
VALUES
('8582123456',N'TIẾNG VIỆT',N'CỨNG',N'CÒN'),
('8783336578',N'TIẾNG VIỆT',N'MỀM',N'CÒN'),
('8884567753',N'TIẾNG VIỆT',N'MỀM',N'CÒN'),
('8985753887',N'TIẾNG VIỆT',N'CỨNG',N'CÒN'),
('8486275432',N'TIẾNG VIỆT',N'CỨNG',N'CÒN')
GO

INSERT INTO MUON
VALUES
('8582123456','CS001','03/25/2020','04/25/2020'),
('8783336578','CS002','05/17/2020','06/17/2020'),
('8884567753','CS003','07/30/2020','08/30/2020'),
('8985753887','CS004','09/10/2020','10/10/2020'),
('8486275432','CS005','12/02/2020','01/02/2021')
GO

INSERT INTO CUONSACH
VALUES
('8582123456','CS001',N'MỚI'),
('8783336578','CS002',N'CŨ'),
('8884567753','CS003',N'MỚI'),
('8985753887','CS004',N'CŨ'),
('8486275432','CS005',N'MỚI')
GO

INSERT INTO DANGKY
VALUES
('8582123456','03/20/2020','NULL'),
('8783336578','05/12/2020','NULL'),
('8884567753','07/28/2020','NULL'),
('8985753887','09/07/2020','NULL'),
('8486275432','11/30/2020','NULL')
GO

INSERT INTO QUATRINHMUON
VALUES
('8582123456','CS001','03/25/2020','04/25/2020','04/10/2020',10000,5000,5000,'NULL'),
('8783336578','CS002','05/17/2020','06/17/2020','06/18/2020',20000,10000,5000,N'CÒN THIẾU 5000 VÀ TRẢ TRỄ 1 NGÀY'),
('8884567753','CS003','07/30/2020','08/30/2020','08/15/2020',15000,10000,5000,'NULL'),
('8985753887','CS004','09/10/2020','10/10/2020','09/30/2020',25000,10000,5000,N'CÒN NỢ 10000'),
('8486275432','CS005','12/02/2020','01/02/2021','01/01/2021',17000,10000,7000,'NULL')
GO


--
---5A
--A
SELECT YEAR(NGAYMUON) 'NĂM', COUNT(ISBN) AS 'PHIẾU MƯỢN SÁCH'
FROM MUON
GROUP BY YEAR(NGAYMUON)
--5B
SELECT  DATEDIFF(DAY,NGAYMUON,NGAYTRA) AS [SỐ NGÀY MƯỢN] FROM DBO.QUATRINHMUON
--5C
SELECT MA_CUONSACH,COUNT(MA_CUONSACH) AS [SO LAN MUON],(SUM(DATEDIFF(DAY, NGAYMUON,NGAYTRA))/ COUNT(MA_CUONSACH)) AS [NGAY MUON TRUNG BINH]
FROM QUATRINHMUON GROUP BY MA_CUONSACH
--5D
SELECT A.ISBN, A.Ma_CuonSach, A.NgayMuon, B.NgayTra
FROM Muon A JOIN QuaTrinhMuon B ON A.ISBN = B.ISBN
WHERE A.Ma_CuonSach = B.Ma_CuonSach
WHERE DAY(NgayHetHan)-DAY(NgayMuon) > 0


SELECT QTM.NgayTra, M.NgayMuon,qtm.NgayHetHan,DG.Ten
FROM QuaTrinhMuon qtm join DocGia dg on qtm.Ma_DocGia = dg.Ma_DocGia
					  join Muon m on dg.Ma_DocGia = m.Ma_DocGia
--WHERE DAY(QTM.NgayTrA)-DAY(M.NgayMuon) > 14
--where datediff(DAY,qtm.ngaytra,m.ngaymuon) > 14
where qtm.NgayHetHan < qtm.NgayTra