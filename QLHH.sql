CREATE DATABASE BTQLHH
USE BTQLHH

CREATE TABLE KHACHHANG 
(
	MAKHACHHANG VARCHAR(10) NOT NULL PRIMARY KEY,
	TENCONGTY NVARCHAR(100) NOT NULL,
	TENGIAODICH NVARCHAR(100) NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	EMAIL VARCHAR(20) NOT NULL,
	DIENTHOAI VARCHAR(20) NOT NULL,
	FAX VARCHAR(20) NOT NULL
)
CREATE TABLE NHANVIEN
(
	MANHANVIEN VARCHAR(10) NOT NULL PRIMARY KEY,
	HO NVARCHAR(30) NOT NULL,
	TEN NVARCHAR(10) NOT NULL,
	NGAYSINH DATE NOT NULL,
	NGAYLAMVIEC DATE NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	DIENTHOAI VARCHAR(20) ,
	LUONGCOBAN MONEY,
	PHUCAP MONEY
)

CREATE TABLE NHACUNGCAP
(
	MACONGTY VARCHAR(20) NOT NULL PRIMARY KEY,
	TENCONGTY NVARCHAR(100) NOT NULL,
	TENGIAODICH NVARCHAR(100) NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	DIENTHOAI VARCHAR(20) NOT NULL,
	FAX VARCHAR(20) NOT NULL,
	EMAIL VARCHAR(20) NOT NULL
)
CREATE TABLE LOAIHANG
(
	MALOAIHANG VARCHAR(10) NOT NULL PRIMARY KEY,
	TENLOAIHANG NVARCHAR(100) NOT NULL
)

CREATE TABLE MATHANG
(
	MAHANG VARCHAR(10) NOT NULL PRIMARY KEY ,
	TENHANG NVARCHAR(100) NOT NULL,
	MACONGTY VARCHAR(20) NOT NULL,
	MALOAIHANG VARCHAR(10) NOT NULL,
	SOLUONG DECIMAL (10,2) NOT NULL,
	DONVITINH NVARCHAR(20) NOT NULL,
	GIAHANG MONEY NOT NULL

)

CREATE TABLE DONDATHANG
(
	SOHOADON VARCHAR(10) NOT NULL PRIMARY KEY,
	MAKHACHHANG VARCHAR(10) NOT NULL,
	MANHANVIEN VARCHAR(10) NOT NULL,
	NGAYDATHANG DATE,
	NGAYNHANHANG DATE,
	NGAYCHUYENHANG DATE,
	NOIGIAOHANG DATE
)
ALTER TABLE DONDATHANG
ALTER COLUMN NOIGIAOHANG NVARCHAR(100)
CREATE TABLE CTDATHANG
(
	SOHOADON VARCHAR(10) NOT NULL,
	MAHANG VARCHAR(10) NOT NULL,
	PRIMARY KEY (SOHOADON,MAHANG),
	GIABAN MONEY NOT NULL,
	SOLUONG DECIMAL(10,2) NOT NULL,
	MUCGIAMGIA DECIMAL(4,2) NOT NULL
)

ALTER TABLE CTDATHANG
ADD CONSTRAINT FK_CTDH_DT FOREIGN KEY (SOHOADON) REFERENCES DONDATHANG(SOHOADON)

ALTER TABLE CTDATHANG
ADD CONSTRAINT FK_CTDH_MH FOREIGN KEY (MAHANG) REFERENCES MATHANG(MAHANG)

ALTER TABLE MATHANG
ADD CONSTRAINT FK_MH_LH FOREIGN KEY (MALOAIHANG) REFERENCES LOAIHANG(MALOAIHANG)

ALTER TABLE MATHANG
ADD CONSTRAINT FK_MH_NCC FOREIGN KEY (MACONGTY) REFERENCES NHACUNGCAP(MACONGTY)

ALTER TABLE DONDATHANG
ADD CONSTRAINT FK_DH_KH FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG)

ALTER TABLE DONDATHANG
ADD CONSTRAINT FK_DH_NV FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)
--=====================================================================================

INSERT INTO KHACHHANG VALUES ('KH01', N'VIỆT TIẾN', N'ÁO VEST', N'VĨNH LƯƠNG','KH1@GMAIL.COM', '0010002', 'FAXKH01')
INSERT INTO KHACHHANG VALUES ('KH02', N'SỮA VIỆT NAM', N'VINAMMILK', N'VĨNH HẢI','KH2@GMAIL.COM', '023322', 'FAXKH02')
INSERT INTO KHACHHANG VALUES ('KH03', N'VIỆT TIẾN', N'CÀ VẸT', N'VĨNH PHƯỚC','KH3@GMAIL.COM', '323200', 'FAXKH03')
INSERT INTO KHACHHANG VALUES ('KH04', N'SEN VÀNG', N'GẠO', N'VĨNH HẢI','KH4@GMAIL.COM', '9898666', 'FAXKH04')
INSERT INTO KHACHHANG VALUES ('KH05', N'HƯNG THỊNH', N'CÁ HỘP', N'VĨNH PHƯỚC','KH5@GMAIL.COM', '6556', 'FAXKH05')
INSERT INTO KHACHHANG VALUES ('KH06', N'SỮA VIỆT NAM', N'SỮA HỘP XYZ', N'VĨNH PHƯỚC','KH6@GMAIL.COM', '111111', 'FAXKH06')


INSERT INTO NHANVIEN VALUES ('NV01', N'LÊ VĂN', N'THANH', '3/3/1995', '6/6/2011',N'VĨNH LƯƠNG', '233232','4500000', '200000')
INSERT INTO NHANVIEN VALUES ('NV02', N'TRÂN VĂN', N'NAM', '4/5/1980', '6/6/2010',N'VĨNH HẢI', '3255555','3500000', '200000')
INSERT INTO NHANVIEN VALUES ('NV03', N'BÙI THỊ', N'HOA', '3/3/1998', '6/6/2017',N'VĨNH THỌ', '877777','4200000', '200000')
INSERT INTO NHANVIEN VALUES ('NV04', N'NGUYỄN VĂN', N'HẢI', '3/3/1987', '6/6/2012',N'VĨNH HẢI', '99999','4000000', '200000')
INSERT INTO NHANVIEN VALUES ('NV05', N'LÊ THỊ', N'LAN', '3/3/1991', '6/6/2020',N'VĨNH LƯƠNG', '7788788','2500000', '200000')
INSERT INTO NHANVIEN VALUES ('NV06', N'LÊ THỊ', N'MAI', '3/3/1991', '6/6/2021',N'VĨNH LƯƠNG', '55555','2600000', '200000')



INSERT INTO LOAIHANG VALUES('TP', N'THỰC PHẨM')
INSERT INTO LOAIHANG VALUES('MAY', N'MAY MẶC')
INSERT INTO LOAIHANG VALUES('GD', N'GIA DỤNG')
INSERT INTO LOAIHANG VALUES('XD', N'XÂY DỰNG')
INSERT INTO LOAIHANG VALUES('DT', N'ĐIỆN TỬ')



INSERT INTO NHACUNGCAP VALUES ('CTY1',N'VIỆT TIẾN',N'ÁO VEST' ,N'NHA TRANG', '0010002', 'FACTY01','CTY1@GMAIL.COM')
INSERT INTO NHACUNGCAP VALUES ('CTY2',N'SEN VÀNG',N'GẠO' ,N'HỒ CHÍ MINH', '032322', 'FACTY02','CTY2@GMAIL.COM')
INSERT INTO NHACUNGCAP VALUES ('CTY3',N'HƯNG THỊNH',N'CÁ HỘP' ,N'HÀ NỘI', '0010002', 'FACTY03','CTY3@GMAIL.COM')
INSERT INTO NHACUNGCAP VALUES ('CTY4',N'HOÀ PHÁT',N'THÉP' ,N'HÀ NỘI', '5545', 'FACTY04','CTY4@GMAIL.COM')
INSERT INTO NHACUNGCAP VALUES ('CTY5',N'GEARVN',N'LAPTOP' ,N'BÌNH DƯƠNG', '77777', 'FACTY05','CTY5@GMAIL.COM')
INSERT INTO NHACUNGCAP VALUES ('CTY6',N'SỮA VIỆT NAM',N'VINAMMILK' ,N'HỒ CHÍ MINH', '556677', 'FACTY06','CTY6@GMAIL.COM')


INSERT INTO MATHANG VALUES('TP01', N'SỮA HỘP XYZ','CTY6','TP','50',N'HỘP','7000')
INSERT INTO MATHANG VALUES('TP02', N'SỮA ĐẶC ABC','CTY6','TP','100',N'HỘP','23000')
INSERT INTO MATHANG VALUES('MAY1', N'ÁO VEST','CTY1','MAY','200',N'CHIẾC','200000')
INSERT INTO MATHANG VALUES('MAY2', N'CÀ VẸT','CTY1','MAY','100',N'CHIẾC','125000')
INSERT INTO MATHANG VALUES('XD1', N'THÉP','CTY4','XD','500',N'KG','70000')
INSERT INTO MATHANG VALUES('DT1', N'BÀN PHÍM CƠ','CTY5','DT','500',N'CHIẾC','580000')
INSERT INTO MATHANG VALUES('TP3', N'CÁ HỘP','CTY3','TP','80',N'HỘP','30000')


INSERT INTO DONDATHANG VALUES ('HD1','KH01','NV01','3/4/2019','4/18/2019','8/4/2019', N'NHA TRANG')
INSERT INTO DONDATHANG VALUES ('HD2','KH02','NV01','4/13/2019','4/28/2019','4/18/2019',N'VŨNG TÀU')
INSERT INTO DONDATHANG VALUES ('HD3','KH03','NV03','3/5/2019','5/25/2019','8/5/2019',N'ĐÀ LẠT')
INSERT INTO DONDATHANG VALUES ('HD4','KH01','NV02','1/6/2018','6/6/2018','8/6/2018','HỒ CHÍ MINH')
INSERT INTO DONDATHANG VALUES ('HD5','KH04','NV04','3/4/2019','4/18/2019','8/4/2019','NHA TRANG')
INSERT INTO DONDATHANG VALUES ('HD6','KH04','NV04','4/4/2019','5/18/2019','6/4/2019','NHA TRANG')


INSERT INTO CTDATHANG VALUES('HD1','DT1','580000',3,0.05)
INSERT INTO CTDATHANG VALUES('HD2','XD1','80000',10,0.05)
INSERT INTO CTDATHANG VALUES('HD3','TP01','8000',20,0.1)
INSERT INTO CTDATHANG VALUES('HD3','TP02','24000',20,0.1)
INSERT INTO CTDATHANG VALUES('HD4','MAY1','210000',4,0.3)
INSERT INTO CTDATHANG VALUES('HD5','TP3','30000',7,0.05)
INSERT INTO CTDATHANG VALUES('HD6','TP3','30000',2,0.05)
INSERT INTO CTDATHANG VALUES('HD5','DT1','580000',600,0.05)
INSERT INTO CTDATHANG VALUES('HD4','DT1','580000',600,0.05)



--===================================================================
-- CÂU 1
-- DANH SÁCH CÁC CÔNG TY CÓ CUNG CÂP HÀNG CHO CÔNG TY 
SELECT TENCONGTY
FROM NHACUNGCAP
WHERE NHACUNGCAP.MACONGTY IN (SELECT MATHANG.MACONGTY FROM MATHANG)

SELECT TENCONGTY
FROM NHACUNGCAP

SELECT * FROM MATHANG

--CÂU 2
SELECT A.MAHANG, A.TENHANG, SUM(A.SOLUONG) -SUM(B.SOLUONG ) AS KHO
FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG = B.MAHANG
GROUP BY A.TENHANG,A.MAHANG,A.SOLUONG, B.SOLUONG


--CÂU 3
SELECT A.HO + ' '+ A.TEN AS HOTEN, A.DIACHI, YEAR(A.NGAYLAMVIEC) AS NAMLAMVIEC
FROM NHANVIEN A

--CÂU 4
SELECT B.DIACHI, B.DIENTHOAI, B.TENCONGTY
FROM KHACHHANG A JOIN NHACUNGCAP B ON A.TENGIAODICH = B.TENGIAODICH
WHERE B.TENGIAODICH ='VINAMMILK'

-- CÂU 5 DO DỮ LIỆU K THOẢ, NHƯNG ĐÚNG
SELECT A.MAHANG, A.TENHANG
FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG = B.MAHANG
GROUP BY A.TENHANG,A.MAHANG, A.GIAHANG
HAVING (SUM(A.SOLUONG) - SUM(B.SOLUONG) < 50 )AND (A.GIAHANG > 100000)

SELECT MATHANG.MAHANG,TENHANG,SUM(MATHANG.SOLUONG)-SUM(CTDATHANG.SOLUONG) AS SOLUONGCONLAI
FROM MATHANG JOIN CTDATHANG ON MATHANG.MAHANG = CTDATHANG.MAHANG
WHERE GIAHANG<100000
GROUP BY MATHANG.MAHANG,TENHANG
HAVING SUM(MATHANG.SOLUONG)-SUM(CTDATHANG.SOLUONG) < 50



-- CÂU 6
SELECT A.TENHANG, B.TENCONGTY
FROM MATHANG A JOIN NHACUNGCAP B ON A.MACONGTY = B.MACONGTY

-- CÂU 7
SELECT A.TENHANG, B.TENCONGTY
FROM MATHANG A JOIN NHACUNGCAP B ON A.MACONGTY = B.MACONGTY
WHERE B.TENCONGTY = N'VIỆT TIẾN'

-- CÂU 8
SELECT B.TENCONGTY, B.DIACHI
FROM MATHANG A  JOIN NHACUNGCAP B ON A.MACONGTY  = B.MACONGTY 
				JOIN LOAIHANG C ON A.MALOAIHANG = C.MALOAIHANG
WHERE C.TENLOAIHANG = N'THỰC PHẨM'
GROUP BY B.TENCONGTY,B.DIACHI

--CÂU 9
SELECT A.MAKHACHHANG,A.TENGIAODICH
FROM KHACHHANG A JOIN DONDATHANG B ON A.MAKHACHHANG = B.MAKHACHHANG 
				 JOIN CTDATHANG C ON B.SOHOADON = C.SOHOADON 
				 JOIN MATHANG D ON C.MAHANG = D.MAHANG
WHERE D.TENHANG = N'SỮA HỘP XYZ'


SELECT KH.TENGIAODICH
FROM KHACHHANG KH INNER JOIN NHACUNGCAP NCC ON KH.TENGIAODICH=NCC.TENGIAODICH
				  INNER JOIN MATHANG MH ON NCC.MACONGTY=MH.MACONGTY
WHERE MH.TENHANG=N'SUA HOP XYZ'
--CÂU 10
SELECT B.MAKHACHHANG , A.MANHANVIEN ,A.NGAYDATHANG, A.NOIGIAOHANG
FROM DONDATHANG A JOIN KHACHHANG B ON A.MAKHACHHANG = B.MAKHACHHANG
WHERE A.SOHOADON = 'HD1'
--CÂU 11
SELECT A.HO + ' '+ A.TEN AS HOTEN, SUM(A.LUONGCOBAN+A.PHUCAP) AS LUONG
FROM NHANVIEN A
GROUP BY A.HO,A.TEN
--CÂU 12
SELECT C.MAHANG, C.SOLUONG, SUM(C.SOLUONG * C.GIABAN - C.SOLUONG*C.GIABAN*C.MUCGIAMGIA) AS THANH_TIEN
FROM DONDATHANG A JOIN KHACHHANG B ON A.MAKHACHHANG = B.MAKHACHHANG 
				  JOIN CTDATHANG C ON A.SOHOADON = C.SOHOADON
WHERE A.SOHOADON = 'HD3'
GROUP BY C.MAHANG, C.SOLUONG

-- CÂU 13
SELECT A.MAKHACHHANG
FROM KHACHHANG A JOIN DONDATHANG C ON A.MAKHACHHANG = C.MAKHACHHANG 
				JOIN CTDATHANG D ON C.SOHOADON = D.SOHOADON 
				JOIN MATHANG E ON E.MAHANG = D.MAHANG 
				JOIN NHACUNGCAP B ON E.MACONGTY  = B.MACONGTY
WHERE A.TENGIAODICH = B.TENGIAODICH


-- CÂU 14
SELECT  NV1.HO, NV1.TEN, NV1.NGAYSINH
FROM NHANVIEN NV1 INNER JOIN NHANVIEN NV2 ON NV1.NGAYSINH = NV2.NGAYSINH 
WHERE NV1.MANHANVIEN<>NV2.MANHANVIEN

--CÂU 15
SELECT DD.SOHOADON,NCC.TENCONGTY
FROM DONDATHANG DD JOIN CTDATHANG CT ON DD.SOHOADON=CT.SOHOADON
JOIN MATHANG MH ON CT.MAHANG=MH.MAHANG
JOIN NHACUNGCAP NCC ON MH.MACONGTY=NCC.MACONGTY
WHERE DD.NOIGIAOHANG = NCC.DIACHI


-- 15 
SELECT DD.SOHOADON,NCC.TENCONGTY
FROM DONDATHANG DD JOIN CTDATHANG CT ON DD.SOHOADON=CT.SOHOADON
JOIN MATHANG MH ON CT.MAHANG=MH.MAHANG
JOIN NHACUNGCAP NCC ON MH.MACONGTY=NCC.MACONGTY
WHERE DD.NOIGIAOHANG = NCC.DIACHI

-- CÂU 16 KHÓ 
SELECT A.TENCONGTY
FROM KHACHHANG A, NHACUNGCAP B, DONDATHANG C, CTDATHANG D
WHERE A.TENCONGTY = B.TENCONGTY AND A.MAKHACHHANG = C.MAKHACHHANG

--CÂU 17
SELECT A1.TENHANG
FROM MATHANG  A1
WHERE A1.TENHANG NOT IN (SELECT A.TENHANG
						 FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG = B.MAHANG 
										JOIN DONDATHANG C ON B.SOHOADON = C.SOHOADON)


SELECT A.TENHANG
FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG = B.MAHANG JOIN DONDATHANG C ON B.SOHOADON = C.SOHOADON

-- CÂU 18
SELECT A1.TEN
FROM NHANVIEN A1
WHERE A1.TEN NOT IN (SELECT A.TEN
					FROM NHANVIEN A JOIN DONDATHANG B ON A.MANHANVIEN = B.MANHANVIEN
					GROUP BY A.TEN)

SELECT A.TEN
FROM NHANVIEN A JOIN DONDATHANG B ON A.MANHANVIEN = B.MANHANVIEN
GROUP BY A.TEN

SELECT * FROM DONDATHANG
SELECT * FROM NHANVIEN
--CÂU 19
SELECT A1.TEN, A1.LUONGCOBAN
FROM NHANVIEN A1
WHERE A1.LUONGCOBAN >= ALL (SELECT A.LUONGCOBAN FROM NHANVIEN A )

--CÂU 20 HAY
SELECT A.MAKHACHHANG, B.SOHOADON ,SUM(B.SOLUONG * B.GIABAN - B.SOLUONG*B.GIABAN*B.MUCGIAMGIA/100) AS THANH_TIEN
FROM DONDATHANG A JOIN CTDATHANG B ON A.SOHOADON = B.SOHOADON
GROUP BY B.SOHOADON, A.MAKHACHHANG
-- CÂU 21
SELECT A.TENHANG
FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG = B.MAHANG JOIN DONDATHANG C ON B.SOHOADON = C.SOHOADON
WHERE YEAR(C.NGAYDATHANG) = 2019
GROUP BY A.TENHANG
HAVING COUNT(B.MAHANG) = 1

--CÂU 22
SELECT C.MAKHACHHANG, c.TENGIAODICH ,SUM(B.SOLUONG * B.GIABAN - B.SOLUONG*B.GIABAN*B.MUCGIAMGIA/100) AS THANH_TIEN
FROM DONDATHANG A JOIN CTDATHANG B ON A.SOHOADON = B.SOHOADON JOIN KHACHHANG C ON C.MAKHACHHANG = A.MAKHACHHANG
GROUP BY  C.MAKHACHHANG, C.TENGIAODICH
--CÂU 23
select nv.MANHANVIEN, nv.HO+ ' ' + nv.TEN as HOTEN,count (dh.SOHOADON) as [DON HANG]
from NHANVIEN  nv join DONDATHANG dh on nv.MANHANVIEN=dh.MANHANVIEN
--CÂU 24
SELECT MONTH(DDH.NGAYDATHANG)AS N'THÁNG' , SUM(CTD.GIABAN*CTD.SOLUONG - CTD.GIABAN*CTD.SOLUONG*CTD.MUCGIAMGIA/100) AS N'TỔNG TIỀN THU ĐƯỢC' 
FROM DONDATHANG AS DDH JOIN CTDATHANG AS CTD ON DDH.SOHOADON= CTD.SOHOADON
WHERE YEAR(DDH.NGAYDATHANG) = '2019'
GROUP BY MONTH(DDH.NGAYDATHANG)
--CÂU 25
SELECT A.TENHANG, (SUM(B.GIABAN*B.SOLUONG - B.GIABAN*B.SOLUONG*B.MUCGIAMGIA/100) - SUM(A.GIAHANG*B.SOLUONG)) AS N'LÃI'
FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG = B.MAHANG JOIN DONDATHANG C ON B.SOHOADON = C.SOHOADON
WHERE YEAR(C.NGAYDATHANG) = 2019
GROUP BY A.TENHANG,A.GIAHANG
--CÂU 26
SELECT A.TENHANG ,B.GIABAN ,(A.SOLUONG-B.SOLUONG) AS N'KHO', B.SOLUONG AS N'ĐÃ BÁN'
FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG = B.MAHANG JOIN DONDATHANG C ON B.SOHOADON = C.SOHOADON
GROUP BY A.TENHANG, B.GIABAN,A.SOLUONG,B.SOLUONG

--CÂU 27
SELECT a.MANHANVIEN,HO,TEN, sum(SOLUONG) as N'Số lượng bán được'
FROM NHANVIEN a JOIN DONDATHANG b
ON a.MANHANVIEN = b.MANHANVIEN
JOIN CTDATHANG c
ON b.SOHOADON = c.SOHOADON
GROUP BY a.MANHANVIEN,HO,TEN
HAVING sum(SOLUONG) >= ALL(SELECT sum(SOLUONG)
FROM NHANVIEN a JOIN DONDATHANG b
ON a.MANHANVIEN = b.MANHANVIEN
JOIN CTDATHANG c 
ON b.SOHOADON = c.SOHOADON
GROUP BY a.MANHANVIEN,HO,TEN)


--=============================== CHƯƠNG 6 ================================================
--=============================== BÀI TẬP 1===================================================
--CÂU 1 PROC
GO
CREATE PROC P_THEM_MATHANG 
	(@MAHANG VARCHAR(10) ,
	@TENHANG NVARCHAR(100) ,
	@MACONGTY VARCHAR(20) ,
	@MALOAIHANG VARCHAR(10) ,
	@SOLUONG DECIMAL (10,2) ,
	@DONVITINH NVARCHAR(20) ,
	@GIAHANG MONEY)
AS
BEGIN
	IF @MAHANG NOT IN (SELECT MAHANG FROM MATHANG)  AND @MALOAIHANG IN (SELECT MALOAIHANG FROM LOAIHANG)
													AND @MACONGTY  IN (SELECT MACONGTY FROM NHACUNGCAP )
	INSERT INTO MATHANG VALUES (@MAHANG ,@TENHANG  ,@MACONGTY  ,@MALOAIHANG  ,@SOLUONG  ,@DONVITINH ,@GIAHANG)
	ELSE 
		PRINT 'KHONG THUC HIEN DUOC'
END

Go
EXEC P_THEM_MATHANG 'TP05', N'SỮA HỘP PROC2','CTY6','TP','100',N'HỘP','9000'
--CÂU 2 PROC
GO
CREATE PROC P_TINH_SLBAN (@MAHANG VARCHAR(10))
AS
BEGIN
	SELECT A.TENHANG, SUM(A.SOLUONG - B.SOLUONG) AS SL_BAN
	FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG =B.MAHANG
	WHERE A.MAHANG = @MAHANG
	GROUP BY A.TENHANG
END
EXEC P_TINH_SLBAN TP01

--CÂU 3 FUNCTION
GO
CREATE FUNCTION  F_TINH_SLBAN ()
RETURNS @TIEN_LUONG TABLE ( TENHANG NVARCHAR(100), 
							SL_BAN DECIMAL(10,2))
AS 
BEGIN 
		INSERT INTO @TIEN_LUONG
		SELECT A.TENHANG, SUM(A.SOLUONG - B.SOLUONG) AS SL_BAN
		FROM MATHANG A JOIN CTDATHANG B ON A.MAHANG =B.MAHANG
		GROUP BY A.TENHANG
	RETURN 
END

GO
SELECT * FROM DBO.F_TINH_SLBAN()
--CÂU 4 TRIGGER

IF EXISTS (SELECT NAME FROM SYSOBJECTS
WHERE NAME = 'TR_CTHD_INSERT' AND TYPE='TR' ) 
DROP TRIGGER TR_CTHD_INSERT
GO
CREATE TRIGGER TR_CTHD_INSERT ON CTDATHANG
FOR UPDATE,INSERT
AS 
BEGIN
	IF UPDATE(SOLUONG) BEGIN
	IF EXISTS (
	SELECT MH.MAHANG
	FROM  (SELECT I.MAHANG, SUM( I.SOLUONG - D.SOLUONG) AS TONGSL FROM inserted I JOIN deleted D ON I.MAHANG=D.MAHANG
	GROUP BY I.MAHANG) AS TMP JOIN MATHANG MH ON TMP.MAHANG=MH.MAHANG
	WHERE TMP.TONGSL > MH.SOLUONG)
	BEGIN
		ROLLBACK TRAN 
	END
ELSE BEGIN
		UPDATE MATHANG SET SOLUONG = MATHANG.SOLUONG - TMP1.TONGSL
				FROM (SELECT I.MAHANG, SUM(I.SOLUONG - D.SOLUONG) AS TONGSL FROM inserted I JOIN deleted D ON I.MAHANG = D.MAHANG
	GROUP BY I.MAHANG) AS TMP1 WHERE MATHANG.MAHANG=TMP1.MAHANG
	END END
	else begin
	IF EXISTS (
	SELECT MH.MAHANG
	FROM  (SELECT I.MAHANG, SUM(I.SOLUONG) AS TONGSL FROM inserted I 
	GROUP BY I.MAHANG) AS TMP JOIN MATHANG MH ON TMP.MAHANG=MH.MAHANG
	WHERE TMP.TONGSL > MH.SOLUONG)
	ROLLBACK TRAN 
	END
	UPDATE MATHANG SET SOLUONG = MATHANG.SOLUONG - TMP1.TONGSL
				FROM (SELECT I.MAHANG, SUM(I.SOLUONG) AS TONGSL FROM inserted I 
	GROUP BY I.MAHANG) AS TMP1 WHERE MATHANG.MAHANG=TMP1.MAHANG
 END

--CÂU 5 TRIGGER
GO
CREATE TRIGGER IUTR_CTDATHANG
ON CTDATHANG
FOR INSERT,UPDATE
AS
IF UPDATE(GIABAN)
	IF EXISTS(  SELECT B.MAHANG
				FROM MATHANG A INNER JOIN INSERTED B  
				ON A.MAHANG=B.MAHANG
				WHERE A.GIAHANG>B.GIABAN)
ROLLBACK TRANSACTION
