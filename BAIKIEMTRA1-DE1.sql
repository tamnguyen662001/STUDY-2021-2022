CREATE DATABASE BAIKIEMTRA1

USE BAIKIEMTRA1

CREATE TABLE DOC_GIA
(
	MSDG VARCHAR(10) PRIMARY KEY NOT NULL,
	HoDG NVARCHAR(20) NOT NULL,
	Ngaysinh DATE NOT NULL,
	Gioitinh VARCHAR(5) NOT NULL,
	Diachi NVARCHAR(50) NOT NULL
)


CREATE TABLE MUON
(
	
	MSDG VARCHAR(10)  NOT NULL,
	MSS VARCHAR(10)  NOT NULL,
	Ngaymuon DATE NOT NULL,
	Ngaytra DATE NOT NULL,
	CONSTRAINT PK_MUON PRIMARY KEY (MSDG, MSS, Ngaymuon)
)

CREATE TABLE SACH
(
	MSS VARCHAR(10) PRIMARY KEY NOT NULL,
	Tensach NVARCHAR(50) NOT NULL,
	Sotrang INT NOT NULL,
	NamXB INT NOT NULL,
	MaNXB VARCHAR(5) NOT NULL --foreign key (MaNXB) references NHA_XUAT_BAN (MaNXB),

	)

CREATE TABLE NHA_XUAT_BAN
(
	MaNXB VARCHAR(5) PRIMARY KEY NOT NULL,
	TeNNXB NVARCHAR(20) NOT NULL,
	Diachi NVARCHAR(50) NOT NULL
)

ALTER TABLE SACH
ADD CONSTRAINT FK_SACH FOREIGN KEY (MaNXB) REFERENCES NHA_XUAT_BAN(MaNXB)

ALTER TABLE MUON
ADD CONSTRAINT FK_DG FOREIGN KEY (MSDG) REFERENCES DOC_GIA(MSDG)

--ALTER TABLE MUON
--ADD CONSTRAINT FK_MUON FOREIGN KEY (MSS) REFERENCES SACH(MSS)

--ALTER TABLE MUON
--DROP CONSTRAINT FK_MUON

-- XỬ LÍ XÓA KHÓA NGOẠI
ALTER TABLE MUON
ADD CONSTRAINT FK_MUON FOREIGN KEY (MSS) REFERENCES SACH(MSS)
ON DELETE CASCADE

ALTER TABLE DOC_GIA
ADD TenDG NVARCHAR(10) NOT NULL

--================================



INSERT DOC_GIA VALUES ('000001','Nguyen Van','5/4/2001' ,'Nam','50 TRAN PHU ','An')
INSERT DOC_GIA VALUES ('000002','Nguyen Thi', '2/3/2001','Nu','440 CONG QUYNH', 'Lan')
INSERT DOC_GIA VALUES ('000003','Tran Van', '7/4/2000','Nam','140 CONG QUYNH', 'Tuan')
INSERT DOC_GIA VALUES ('000004','Le Van', '2/12/2001','Nam','140  NGO QUYEN', 'Duy')
INSERT DOC_GIA VALUES ('000005','Duong Thi', '3/7/2000','Nu','160 CONG QUYNH', 'Mai')


INSERT MUON VALUES ('000001','001','5/4/2021' ,'7/4/2021')
INSERT MUON VALUES ('000002','002','5/8/2021' ,'7/9/2021')
INSERT MUON VALUES ('000003','003','1/2/2021' ,'7/4/2021')
INSERT MUON VALUES ('000004','004','1/4/2021' ,'7/12/2021')
INSERT MUON VALUES ('000005','005','5/8/2021' ,'7/11/2021')
INSERT MUON VALUES ('000002','003','5/1/2019' ,'7/3/2019')
INSERT MUON VALUES ('000003','003','2/2/2021' ,'11/3/2021')
INSERT MUON VALUES ('000005','005','5/8/2010' ,'7/11/2020')
INSERT MUON VALUES ('000005','002','6/6/2010' ,'7/7/2010')
INSERT MUON VALUES ('000002','002','6/6/2003' ,'7/7/2003')

INSERT MUON VALUES ('000001','005','5/6/2004' ,'8/8/2004')
INSERT MUON VALUES ('000001','003','5/4/2005' ,'7/4/2011')
INSERT MUON VALUES ('000001','004','2/3/2005' ,'1/4/2012')
INSERT MUON VALUES ('000001','002','8/8/2021' ,'7/4/2021')


INSERT SACH VALUES ('001','Lap trinh C',200 ,2011,'001')
INSERT SACH VALUES ('002','Lap trinh C#',300 ,2002,'003')
INSERT SACH VALUES ('005','Lap trinh WEB ',500 ,2004,'004')
INSERT SACH VALUES ('003','Lap trinh PYTHON',340 ,2001,'002')
INSERT SACH VALUES ('004','Lap trinh JAVA',430 ,2009,'005')



INSERT NHA_XUAT_BAN VALUES ('001','THANH NIEN','HA NOI')
INSERT NHA_XUAT_BAN VALUES ('002','GIAO DUC','HUE')
INSERT NHA_XUAT_BAN VALUES ('003','PHUONG NAM','HCM')
INSERT NHA_XUAT_BAN VALUES ('004','HA NOI','HN')
INSERT NHA_XUAT_BAN VALUES ('005','PHUONG BAC','HCM')


--====================================================

--CAU 1
SELECT A.MaNXB, A.MSS, A.NamXB, A.Sotrang,	A.Tensach
FROM SACH A, NHA_XUAT_BAN B 
WHERE A.MaNXB = B.MaNXB AND (A.Sotrang <= 200 AND B.TeNNXB = 'GIAO DUC')

--CAU 2
SELECT B.TenDG, A.MSDG,  D.Tensach, C.TeNNXB, A.Ngaymuon, A.Ngaytra
FROM MUON A, DOC_GIA B, NHA_XUAT_BAN C, SACH D
WHERE A.MSDG = B.MSDG AND A.MSS = D.MSS AND C.MaNXB = D.MaNXB AND (A.Ngaymuon BETWEEN '1/1/2021' AND '3/31/2021 '
						AND A.Ngaytra BETWEEN '1/1/2021' AND '3/31/2021')


SELECT DG.MSDG,DG.TENDG,S.Tensach,NXB.TeNNXB,M.Ngaymuon,M.Ngaytra
FROM DOC_GIA DG JOIN MUON M ON DG.MSDG= M.MSDG
JOIN SACH S ON M.MSS=S.MSS
JOIN NHA_XUAT_BAN NXB ON S.MaNXB=NXB.MaNXB 
WHERE  DATEPART(QUARTER, M.Ngaymuon) = 1 AND DATEPART(QUARTER, M.Ngaytra) = 1 AND YEAR(M.Ngaymuon) = 2021 AND YEAR(M.Ngaytra) = 2021

--CAU 3
SELECT C.Tensach, COUNT(B.MSS) AS SO_LAN_MUON, DATEPART(quarter, B.Ngaymuon) as Quy
FROM DOC_GIA A, MUON B, SACH C
WHERE A.MSDG = B.MSDG AND B.MSS = C.MSS AND YEAR(B.Ngaymuon) = 2018
GROUP BY  C.Tensach,DATEPART(quarter, B.Ngaymuon)
ORDER BY C.Tensach

SELECT *
FROM MUON

 -- CÂU 4
 -- LẤY RA SÁCH K ĐC MƯỢN
SELECT *
FROM SACH 
 WHERE SACH.MSS IN (
		SELECT A1.MSS
		FROM  MUON A1
		WHERE YEAR(A1.Ngaymuon) NOT BETWEEN 2009 AND 2019)

DELETE 
FROM SACH 
WHERE SACH.MSS IN (
		SELECT A1.MSS
		FROM  MUON A1
		WHERE YEAR(A1.Ngaymuon) NOT BETWEEN 2009 AND 2019)													


SELECT *
FROM MUON

SELECT *
FROM NHA_XUAT_BAN

delete from NHA_XUAT_BAN where MaNXB = '005'

SELECT *
FROM SACH
-- CÂU 5
SELECT A.Gioitinh,A.TenDG, B.MSDG, A.Ngaysinh , count (b.MSS) as slmuon
FROM DOC_GIA A, MUON B
WHERE A.MSDG = B.MSDG 
GROUP BY A.Gioitinh,A.TenDG, B.MSDG, A.Ngaysinh
HAVING COUNT(B.MSS) >= ALL (
							SELECT COUNT(B1.MSS)
							FROM  MUON B1 join DOC_GIA a1 on a1.MSDG = b1.MSDG
							where a1.Gioitinh = 'nu'
							GROUP BY B1.MSDG
						) and a.Gioitinh = 'nu'
						

						

-- CÂU 6
SELECT   A.MSDG,A.TenDG,A.Gioitinh, COUNT(B1.MSS) AS SL_MUON
FROM DOC_GIA A join MUON B1 ON A.MSDG = B1.MSDG
where a.Gioitinh ='nu'
GROUP BY  A.MSDG,A.TenDG,A.Gioitinh




SELECT   A.MSDG, A.HoDG, A.TenDG,A.Gioitinh, A.Diachi, COUNT(B1.MSS) AS SL_MUON
FROM DOC_GIA A join MUON B1 ON A.MSDG = B1.MSDG
WHERE   not exists
	(
		SELECT * FROM SACH C 
		WHERE  not exists
		(
			SELECT * FROM MUON B2
			WHERE  B1.MSDG = B2.MSDG and B2.MSS = C.MSS
		)
	)
GROUP BY  A.MSDG, A.HoDG, A.TenDG,A.Gioitinh, A.Diachi


SELECT DISTINCT DG.TenDG
FROM MUON M JOIN DOC_GIA DG ON M.MSDG=DG.MSDG
WHERE NOT EXISTS (SELECT * 
FROM MUON M1 
WHERE NOT EXISTS (SELECT * FROM MUON M2 WHERE M2.MSS=M1.MSS AND M2.MSDG =M.MSDG)
)



--2B
SELECT KH.HOLOT+ ' '+KH.TEN AS [TÊN KHÁCH HÀNG], (VT.DONGIA*BH.SOLUONG) AS [TONG TIEN] 
FROM BANHANG BH JOIN VATTU VT ON BH.MSVT=VT.MSVT
JOIN KHACHHANG KH ON KH.MSKH = BH.MSKH
ORDER BY (VT.DONGIA*BH.SOLUONG) ASC

SELECT MONTH(BH.Ngayban) AS Thang, SUM(VT.Dongia*BH.Soluong) AS SoTien
FROM BANHANG BH JOIN VATTU VT ON BH.MSVT=VT.MSVT
WHERE YEAR(BH.Ngayban)=2018
GROUP BY MONTH(BH.Ngayban)

cau d :SELECT NV.HoTen,SUM (BH.Soluong) AS 'SL BAN'
FROM BANHANG BH JOIN NHANVIEN NV ON BH.MSNV = NV.MSNV
GROUP BY NV.HoTen
HAVING SUM (BH.Soluong) >= ALL (SELECT SUM(BH.Soluong) FROM BANHANG BH GROUP BY MSNV)

UPDATE NHANVIEN
SET Luong = Luong + Luong*0.2
WHERE MSNV in
	(SELECT BH.MSNV
	 FROM BANHANG 
	 WHERE SUM(BH.Soluong) >= 80)

	drop view maxkh trong bảng bán hàng in trong mkh trong bản khách hàng, và đk mnv



	--CAU 1
SELECT A.MaNXB, A.MSS, A.NamXB, A.Sotrang,	A.Tensach
FROM SACH A, NHA_XUAT_BAN B 
WHERE A.MaNXB = B.MaNXB AND (A.Sotrang <= 200 AND B.TeNNXB = 'GIAO DUC')
--CAU 2
SELECT B.TenDG, A.MSDG,  D.Tensach, C.TeNNXB, A.Ngaymuon, A.Ngaytra
FROM MUON A, DOC_GIA B, NHA_XUAT_BAN C, SACH D
WHERE A.MSDG = B.MSDG AND A.MSS = D.MSS AND C.MaNXB = D.MaNXB AND (A.Ngaymuon BETWEEN '1/1/2019' AND '12/30/2019 '
						AND A.Ngaytra BETWEEN '1/1/2019' AND '12/30/2019')
--CAU 3
SELECT C.Tensach, COUNT(B.MSS) AS SO_LAN_MUON, DATEPART(quarter, B.Ngaymuon) as Quy
FROM DOC_GIA A, MUON B, SACH C
WHERE A.MSDG = B.MSDG AND B.MSS = C.MSS AND YEAR(B.Ngaymuon) = 2021
GROUP BY  C.Tensach,DATEPART(quarter, B.Ngaymuon)
ORDER BY C.Tensach

SELECT *
FROM MUON

 -- CÂU 4
 -- LẤY RA SÁCH K ĐC MƯỢN
SELECT *
FROM SACH 
 WHERE SACH.MSS IN (
		SELECT A1.MSS
		FROM  MUON A1
		WHERE YEAR(A1.Ngaymuon) NOT BETWEEN 2009 AND 2021)

DELETE 
FROM SACH 
WHERE SACH.MSS IN (
		SELECT A1.MSS
		FROM  MUON A1
		WHERE YEAR(A1.Ngaymuon) NOT BETWEEN 2009 AND 2021)													


SELECT *
FROM MUON

SELECT *
FROM DOC_GIA

SELECT *
FROM SACH
-- CÂU 5
SELECT A.Diachi, A.Gioitinh,A.TenDG, A.MSDG, A.Ngaysinh
FROM DOC_GIA A, MUON B
WHERE A.MSDG = B.MSDG AND A.Gioitinh = 'Nu'
GROUP BY A.Diachi, A.Gioitinh,A.TenDG, A.MSDG, A.Ngaysinh
HAVING COUNT(B.MSS) >= ALL (
							SELECT COUNT(B1.MSS)
							FROM  MUON B1
							GROUP BY B1.MSS
						)
						
-- CÂU 6


SELECT   A.MSDG, A.HoDG, A.TenDG,A.Gioitinh, A.Diachi, COUNT(B1.MSS) AS SL_MUON
FROM DOC_GIA A join MUON B1 ON A.MSDG = B1.MSDG
WHERE   not exists
	(
		SELECT * FROM SACH C 
		WHERE  not exists
		(
			SELECT * FROM MUON B2
			WHERE  B1.MSDG = B2.MSDG and B2.MSS = C.MSS
		)
	)
GROUP BY  A.MSDG, A.HoDG, A.TenDG,A.Gioitinh, A.Diachi