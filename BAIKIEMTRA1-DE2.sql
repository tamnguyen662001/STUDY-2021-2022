CREATE DATABASE BAIKIEMTRA2
GO

USE BAIKIEMTRA2
GO

CREATE TABLE NHANVIEN(
	MSNV VARCHAR(4) NOT NULL,
	HoTen NVARCHAR(50) NOT NULL,
	Gioitinh Bit NOT NULL,
	Diachi NVARCHAR(100) NOT NULL,
	Luong DECIMAL NOT NULL,
	CONSTRAINT NV PRIMARY KEY (MSNV)
)
GO

CREATE TABLE VATTU(
	MSVT VARCHAR(4) NOT NULL,
	TenVT NVARCHAR(50) NOT NULL,
	DVT VARCHAR(5) NOT NULL,
	Dongia DECIMAL NOT NULL,
	CONSTRAINT VT PRIMARY KEY (MSVT)
	
)
GO

CREATE TABLE KHACHHANG(
	MSKH VARCHAR(5) NOT NULL,
	Holot NVARCHAR(30) NOT NULL,
	Ten NVARCHAR(20) NOT NULL,
	Diachi NVARCHAR(100) NOT NULL,
	CONSTRAINT KH PRIMARY KEY (MSKH)
	
)
GO

CREATE TABLE BANHANG(
	SoHD VARCHAR(9) NOT NULL,
	MSKH VARCHAR(5) NOT NULL,
	MSVT VARCHAR(4) NOT NULL,
	Soluong DECIMAL NOT NULL,
	Ngayban DATE NOT NULL,
	MSNV VARCHAR(4) NOT NULL,
	CONSTRAINT BH PRIMARY KEY (SoHD, MSKH, MSVT),
	CONSTRAINT FK_MSNV FOREIGN KEY (MSNV) REFERENCES NHANVIEN,
	CONSTRAINT FK_MSVT FOREIGN KEY (MSVT) REFERENCES VATTU,
	CONSTRAINT FK_MSKH FOREIGN KEY (MSKH) REFERENCES KHACHHANG
)
GO

INSERT INTO NHANVIEN
VALUES ('NV01',N'Nguyễn Phan Hảo',1,N'Số 3, Hoàn Kiến, Hà Nội',10000000)
INSERT INTO NHANVIEN
VALUES ('NV02',N'Nguyễn Minh Trí',1,N'Số 7, Hoàn Kiến, Hà Nội',15000000)
INSERT INTO NHANVIEN
VALUES ('NV03',N'Nguyễn Hữu Tâm',1,N'Số 9, Hoàn Kiến, Hà Nội',20000000)
INSERT INTO NHANVIEN
VALUES ('NV04',N'Phan Hữu Thọ',1,N'74/2 Thị Trấn Vạn Giã',25000000)
INSERT INTO NHANVIEN
VALUES ('NV05',N'Nguyễn Hoàng An Khương',0,N'Đội 2, Thôn Hữu Thọ, Bắc Giang',13000000)


INSERT INTO VATTU
VALUES ('T',N'Thép','m',15000)
INSERT INTO VATTU
VALUES ('S',N'Sắt','m',30000)
INSERT INTO VATTU
VALUES ('XM',N'Xi măng','bao',150000)
INSERT INTO VATTU
VALUES ('ON',N'Ống nước','m',7000)
INSERT INTO VATTU
VALUES ('X',N'Xăng','l',20000)

INSERT INTO KHACHHANG
VALUES ('00001',N'Nguyễn Minh',N'Toàn',N'Đội 4, Huyện Duyên Châu, Thùa Thiên Huế')
INSERT INTO KHACHHANG
VALUES ('00002',N'Nguyễn Hữu',N'Thạch',N'Số 7,  Đường Đoàn Trần Nghiệp, Nha Trang')
INSERT INTO KHACHHANG
VALUES ('00003',N'Đức Phát',N'Lan',N'Thái Hòa, Hữu Châu')
INSERT INTO KHACHHANG
VALUES ('00004',N'Toàn Quang',N'Thắng',N'Đường Huỳnh Thúc Kháng, Hồ Chí Minh')
INSERT INTO KHACHHANG
VALUES ('00005',N'Phất Lan',N'Đức',N'Số 5, Hồ Hoàn Kiếm, Hà Nội')



INSERT INTO BANHANG
VALUES ('030604001','00004','T',20,'20190619','NV01')
INSERT INTO BANHANG
VALUES ('030604002','00002','ON',10,'20201211','NV02')
INSERT INTO BANHANG
VALUES ('030604003','00005','S',35,'20191212','NV02')
INSERT INTO BANHANG
VALUES ('030604004','00001','XM',50,'20200306','NV03')
INSERT INTO BANHANG
VALUES ('030604005','00003','X',10,'20210115','NV04')
INSERT INTO BANHANG
VALUES ('030604006','00002','ON',10,'20201206','NV02')

--==============================================
-- CÂU A
SELECT A.TenVT, A.Dongia
FROM VATTU A
WHERE A.Dongia  > 5000


--CÂU B
SELECT A.MSKH, A.Ten , C.TenVT, B.Soluong, C.Dongia , SUM(B.Soluong * C.Dongia) AS THANHTIEN
FROM KHACHHANG A JOIN BANHANG B ON A.MSKH = B.MSKH JOIN VATTU C ON B.MSVT = C.MSVT
GROUP BY A.Ten, A.MSKH,  C.TenVT, B.Soluong, C.Dongia
ORDER BY  SUM(B.Soluong * C.Dongia) 

--CÂU C
SELECT DATEPART(MONTH, B.NGAYBAN) AS THANG, A.TenVT , SUM(B.Soluong * C.Dongia) AS THANHTIEN
FROM BANHANG B JOIN VATTU A ON A.MSVT = B.MSVT JOIN VATTU C  ON A.MSVT = C.MSVT
WHERE YEAR(B.Ngayban) = 2019
GROUP BY A.TenVT,  C.TenVT, B.Soluong, C.Dongia, DATEPART(MONTH, B.NGAYBAN)


-- CÂU D SL LẦN BÁN NHIỀU NHẤT 
SELECT A.HoTen, COUNT(B.MSNV) AS SL_BAN
FROM NHANVIEN A JOIN BANHANG B ON A.MSNV = B.MSNV
GROUP BY A.HoTen,B.MSNV
HAVING COUNT(B.MSNV) >= ALL(SELECT COUNT(B1.MSNV) 
							FROM NHANVIEN A1 JOIN BANHANG B1 ON A1.MSNV = B1.MSNV 
							GROUP BY (B1.MSNV))



-- CÂU D SL MẶT HÀNG BÁN NHIÈU NHẤT 
SELECT A.HoTen, SUM(B.Soluong) AS SL_BAN
FROM NHANVIEN A JOIN BANHANG B ON A.MSNV = B.MSNV
GROUP BY A.HoTen,B.MSNV
HAVING SUM(B.Soluong) >= ALL(SELECT SUM(B1.Soluong) 
							FROM NHANVIEN A1 JOIN BANHANG B1 ON A1.MSNV = B1.MSNV 
							GROUP BY (B1.MSNV))


-- CÂU E 
UPDATE NHANVIEN
SET Luong = Luong * 1.2
WHERE NHANVIEN.MSNV IN (SELECT A1.MSNV
						FROM NHANVIEN A1 JOIN BANHANG B1 ON A1.MSNV = B1.MSNV 
						WHERE YEAR(B1.Ngayban) = 2019
						GROUP BY (A1.MSNV)
						HAVING SUM(B1.Soluong) > 10)


-- CÂU F
GO
CREATE VIEW THONGTIN_KHACHHANG
AS 
		SELECT  A.MSKH , A.Ten
		FROM KHACHHANG A join BANHANG B1 ON A.MSKH = B1.MSKH
		WHERE   not exists
			(
				SELECT * FROM NHANVIEN C
				WHERE  not exists
				(
					SELECT * FROM BANHANG B2
					WHERE  B1.MSNV = B2.MSNV and B2.MSNV = C.MSNV AND C.MSNV = 'NV01'
				)
			)
		GROUP BY  A.MSKH, A.Ten
GO

-- minh tâm
CREATE VIEW CAU_F
AS
SELECT *
FROM KHACHHANG KH 
WHERE NOT EXISTS (  SELECT *
					FROM BANHANG BH JOIN NHANVIEN NV ON BH.MSNV = NV.MSNV
					WHERE NV.MSNV = 'NV01' AND NOT EXISTS (	SELECT *
															FROM BANHANG BH1
															WHERE BH1.MSKH = KH.MSKH AND BH1.MSNV = NV.MSNV))
GO

SELECT  *
FROM BANHANG
WHERE	 BANHANG.MSNV = 'NV01'
--====================================

SELECT A1.MSNV, SUM(B1.Soluong) AS SL_BAN
FROM NHANVIEN A1 JOIN BANHANG B1 ON A1.MSNV = B1.MSNV 
WHERE YEAR(B1.Ngayban) = 2019
GROUP BY (A1.MSNV)
HAVING SUM(B1.Soluong) > 10


SELECT SUM(B1.Soluong) 
FROM NHANVIEN A1 JOIN BANHANG B1 ON A1.MSNV = B1.MSNV 
GROUP BY (B1.MSNV)

SELECT * FROM BANHANG





SELECT A1.MSNV ,SUM(B1.Soluong)  AS SL_BAN
FROM NHANVIEN A1 JOIN BANHANG B1 ON A1.MSNV = B1.MSNV 
GROUP BY B1.Soluong,A1.MSNV
HAVING SUM(B1.Soluong) >= 10



IN (SELECT A1.MSNV 
						FROM NHANVIEN A1 JOIN BANHANG B1 ON A1.MSNV = B1.MSNV 
						GROUP BY (A1.MSNV), B1.Ngayban
						HAVING SUM(B1.Soluong) > 10 ) 

--========================================================