CREATE DATABASE KTGIUAKY

USE KTGIUAKY

CREATE TABLE HOCVIEN
(
	MaHV VARCHAR (10) PRIMARY KEY NOT NULL,
	HoHV NVARCHAR(50) NOT NULL,
	TenHV NVARCHAR(50) NOT NULL,
	NgaySinh DATE NOT NULL,
	DiaChi NVARCHAR(100) NOT NULL
)


CREATE TABLE KHOAHOC
(
	MaKH VARCHAR (10) PRIMARY KEY NOT NULL,
	TenKH NVARCHAR(50) NOT NULL,
	NgayBD DATE NOT NULL
)


CREATE TABLE GIAOVIEN
(
	MaGV VARCHAR (10) PRIMARY KEY NOT NULL,
	HoTenGV NVARCHAR(100) NOT NULL,
	DiaChiGV NVARCHAR(100) NOT NULL
)

CREATE TABLE LOPHOC
(	
	MaLH VARCHAR (10) PRIMARY KEY NOT NULL,
	MaKH VARCHAR (10) NOT NULL,
	MaGV VARCHAR (10) NOT NULL,
	HocPhi MONEY NOT NULL
)

CREATE TABLE BIENLAI
(
	SoBL VARCHAR (10) PRIMARY KEY NOT NULL,
	MaLH VARCHAR (10) NOT NULL,
	MaHV VARCHAR (10)  NOT NULL,
	NgayNop DATE NOT NULL
)

ALTER TABLE BIENLAI
ADD CONSTRAINT FK_BL_HV FOREIGN KEY (MaHV) REFERENCES HOCVIEN(MaHV) 

ALTER TABLE BIENLAI
ADD CONSTRAINT FK_BL_LH FOREIGN KEY (MaLH) REFERENCES LOPHOC(MaLH) 

ALTER TABLE LOPHOC
ADD CONSTRAINT FK_LH_KH FOREIGN KEY (MaKH) REFERENCES KHOAHOC(MaKH) 


ALTER TABLE LOPHOC
ADD CONSTRAINT FK_LH_GV FOREIGN KEY (MaGV) REFERENCES GIAOVIEN(MaGV) 


--======================================================================

INSERT INTO HOCVIEN VALUES('HV001',N'LÊ VĂN', N'ĐẠT', '2/2/2001', N'VĨNH LƯƠNG')
INSERT INTO HOCVIEN VALUES('HV002',N'BÙI VĂN', N'AN', '4/12/2001', N'VĨNH HẢI')
INSERT INTO HOCVIEN VALUES('HV003',N'LÊ TẤN', N'LỘC', '4/7/2001', N'VĨNH PHƯỚC')
INSERT INTO HOCVIEN VALUES('HV004',N'TRẦN THỊ', N'NGA', '2/8/2001', N'VĨNH LƯƠNG')
INSERT INTO HOCVIEN VALUES('HV005',N'TRẦN VĂN', N'DŨNG', '5/2/2001', N'VĨNH HẢI')


INSERT INTO KHOAHOC VALUES('25',N'KHOÁ 25', '2/2/2019')
INSERT INTO KHOAHOC VALUES('26',N'KHOÁ 26', '12/2/2020')
INSERT INTO KHOAHOC VALUES('27',N'KHOÁ 27', '2/6/2018')
INSERT INTO KHOAHOC VALUES('24',N'KHOÁ 24', '7/4/2017')
INSERT INTO KHOAHOC VALUES('23',N'KHOÁ 23', '2/2/2016')


INSERT INTO GIAOVIEN VALUES('GV0001',N'LÊ THỊ THUÝ', N'VĨNH HẢI')
INSERT INTO GIAOVIEN VALUES('GV0002',N'LÊ THỊ LAN', N'VĨNH THỌ')
INSERT INTO GIAOVIEN VALUES('GV0003',N'TRẦN VĂN AN', N'VĨNH PHƯỚC')
INSERT INTO GIAOVIEN VALUES('GV0004',N'BÙI CHÍ LỘC', N'VĨNH HẢI')
INSERT INTO GIAOVIEN VALUES('GV0005',N'LÊ THỊ MAI', N'VĨNH LƯƠNG')

INSERT INTO LOPHOC VALUES('001L1','26', 'GV0001', '300000')
INSERT INTO LOPHOC VALUES('001L2','26', 'GV0003', '200000')
INSERT INTO LOPHOC VALUES('001L3','25', 'GV0001', '300000')
INSERT INTO LOPHOC VALUES('001L4','26', 'GV0004', '400000')
INSERT INTO LOPHOC VALUES('001L5','25', 'GV0002', '350000')

INSERT INTO BIENLAI VALUES('B0002','001L1', 'HV001', '12/22/2019')
INSERT INTO BIENLAI VALUES('B0001','001L2', 'HV001', '12/2/2019')
INSERT INTO BIENLAI VALUES('B0007','001L3', 'HV001', '11/2/2019')
INSERT INTO BIENLAI VALUES('B0008','001L4', 'HV001', '11/2/2019')
INSERT INTO BIENLAI VALUES('B00010','001L5', 'HV001', '11/2/2019')
INSERT INTO BIENLAI VALUES('B0009','001L3', 'HV002', '12/5/2019')
INSERT INTO BIENLAI VALUES('B0004','001L4', 'HV003', '12/26/2019')
INSERT INTO BIENLAI VALUES('B0005','001L1', 'HV004', '12/22/2019')
INSERT INTO BIENLAI VALUES('B0006','001L1', 'HV005', '11/2/2019')

--============================================================

SELECT * FROM BIENLAI ORDER BY MaHV

-- CÂU 2 a.	Cho biết học viên học cả 2 lớp “001L1” và “001L2”. (Gồm Mã HV, Họ tên HV).

SELECT A.MaHV, A.HoHV + ' ' + A.TenHV AS TENHV
FROM HOCVIEN A, LOPHOC B, BIENLAI C
WHERE A.MaHV = C.MaHV AND B.MaLH = C.MaLH AND C.MaLH IN ('001L1','001L2')
GROUP BY A.MaHV, A.HoHV, A.TenHV
HAVING COUNT(B.MaLH) >=2



-- b.	Hiển thị số lượng học viên của từng giáo viên theo từng năm học. 
SELECT GV.HOTENGV ,KH.NGAYBD , SL
FROM (SELECT BIENLAI.MALH,COUNT(MAHV) AS SL
	FROM BIENLAI
	GROUP BY BIENLAI.MALH) KQ INNER JOIN LOPHOC LH ON KQ.MALH = LH.MALH
	INNER JOIN GIAOVIEN GV ON LH.MAGV = GV.MAGV
	INNER JOIN KHOAHOC KH ON LH.MAKH = KH.MAKH
GROUP BY GV.HOTENGV ,KH.NGAYBD, SL


SELECT C.HoTenGV, A.NgayBD , SL
FROM  (SELECT D.MaLH, COUNT(D.MaHV) SL FROM BIENLAI D GROUP BY D.MaLH) KQ JOIN LOPHOC B ON KQ.MaLH = B.MaLH JOIN GIAOVIEN C ON B.MaGV = C.MaGV JOIN KHOAHOC A ON A.MaKH = B.MaKH
GROUP BY  C.HoTenGV, A.NgayBD , SL

-- c.	Liệt kê các lớp học chưa có học viên nào đăng ký. Gồm các thông tin: Tên khóa học, Mã lớp, Họ tên giáo viên

SELECT KH.TENKH,KQ.MALH,GV.HOTENGV
FROM GIAOVIEN GV INNER JOIN (
	SELECT LOPHOC.MALH,LOPHOC.MAGV,LOPHOC.MAKH
	FROM  LOPHOC 
	WHERE NOT EXISTS (
		SELECT BIENLAI.MALH
		FROM  BIENLAI 
		WHERE LOPHOC.MALH = BIENLAI.MALH)) KQ ON GV.MAGV = KQ.MAGV INNER JOIN KHOAHOC KH ON KQ.MAKH= KH.MAKH


SELECT BIENLAI.MALH
		FROM  BIENLAI , LOPHOC
		WHERE LOPHOC.MALH = BIENLAI.MALH

--d.	Tăng học phí của các lớp học thuộc khóa “Khóa 25” lên thêm 50000 đồng
UPDATE LOPHOC
SET HocPhi = HocPhi + 50000
WHERE MaKH = '25'

--e.	Liệt kê thông tin của học viên tham gia tất cả các lớp học. 
SELECT A.MaHV, A.HoHV + ' ' + A.TenHV AS TENHV
FROM HOCVIEN A, BIENLAI B1 
WHERE A.MaHV = B1.MaHV AND NOT EXISTS (
										SELECT * 
										FROM LOPHOC C
										WHERE NOT EXISTS (
															SELECT * 
															FROM BIENLAI B2 
															WHERE B1.MaHV = B2.MaHV AND B2.MaLH = C.MaLH ))
GROUP BY A.MaHV, A.HoHV , A.TenHV 

--f.	Liệt kê lớp học có số lượng học viên tham gia học nhiều nhất (Mã lớp học,  Mã GV, Họ tên GV, Số lượng học viên).
SELECT A.MaLH, COUNT(B.MaHV) AS SL_HV
FROM LOPHOC A JOIN BIENLAI B ON A.MaLH = B.MaLH
GROUP BY A.MaLH 
HAVING COUNT(B.MaHV) >= ALL (SELECT COUNT(B1.MaHV)  AS SL_HV FROM BIENLAI B1 GROUP BY B1.MaLH)


-- SỐ LƯỢNG HV MỖI LỚP HỌC
SELECT B1.MaLH, COUNT(B1.MaHV)  AS SL_HV FROM BIENLAI B1 GROUP BY B1.MaLH

SELECT BIENLAI.MALH,COUNT(MAHV) AS SL FROM BIENLAI GROUP BY BIENLAI.MALH

SELECT * FROM BIENLAI